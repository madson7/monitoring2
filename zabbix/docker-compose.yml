version: '3.3'

services:

    zabbix-server:
        image: zabbix/zabbix-server-mysql
        ports:
            - "10051:10051"
        volumes:
            - /etc/localtime:/etc/localtime:ro
            - ./zbx_env/usr/lib/zabbix/alertscripts:/usr/lib/zabbix/alertscripts:ro
            - ./zbx_env/usr/lib/zabbix/externalscripts:/usr/lib/zabbix/externalscripts:ro
            - ./zbx_env/var/lib/zabbix/export:/var/lib/zabbix/export:rw
            - ./zbx_env/var/lib/zabbix/modules:/var/lib/zabbix/modules:ro
            - ./zbx_env/var/lib/zabbix/enc:/var/lib/zabbix/enc:ro
            - ./zbx_env/var/lib/zabbix/ssh_keys:/var/lib/zabbix/ssh_keys:ro
            - ./zbx_env/var/lib/zabbix/mibs:/var/lib/zabbix/mibs:ro
            - ./zbx_env/var/lib/zabbix/snmptraps:/var/lib/zabbix/snmptraps:ro
        links:
            - mysql-server:mysql-server
        env_file:
            - .env_db_mysql
        secrets:
            - MYSQL_USER
            - MYSQL_PASSWORD
            - MYSQL_ROOT_PASSWORD
        user: root
        depends_on:
            - mysql-server
        networks:
            zbx_net_backend:
                aliases:
                    - zabbix-server
            zbx_net_frontend:

    zabbix-web-apache-mysql:
        image: zabbix-web-apache-mysql
        ports:
            - "80:80"
            - "443:443"
        links:
            - mysql-server:mysql-server
            - zabbix-server:zabbix-server
        volumes:
            - /etc/localtime:/etc/localtime:ro
            - ./zbx_env/etc/ssl/apache2:/etc/ssl/apache2:ro
        env_file:
            - .env_db_mysql
            - .env_web
        secrets:
            - MYSQL_USER
            - MYSQL_PASSWORD
        user: root
        depends_on:
            - mysql-server
            - zabbix-server
        networks:
            zbx_net_backend:
            aliases:
                - zabbix-web-apache-mysql
            zbx_net_frontend:

    mysql-server:
        image: mysql:8.0
        command: [mysqld, --character-set-server=utf8, --collation-server=utf8_bin, --default-authentication-plugin=mysql_native_password]
        volumes:
            - ./zbx_env/var/lib/mysql:/var/lib/mysql:rw
        env_file:
            - .env_db_mysql
        secrets:
            - MYSQL_USER
            - MYSQL_PASSWORD
            - MYSQL_ROOT_PASSWORD
        user: root
        networks:
        zbx_net_backend:
            aliases:
                - mysql-server

networks:
    zbx_net_frontend:
        driver: bridge
        driver_opts:
            com.docker.network.enable_ipv6: "false"

    zbx_net_backend:
        driver: bridge
        driver_opts:
            com.docker.network.enable_ipv6: "false"

secrets:
    MYSQL_USER:
        file: ./.MYSQL_USER
    MYSQL_PASSWORD:
        file: ./.MYSQL_PASSWORD
    MYSQL_ROOT_PASSWORD:
        file: ./.MYSQL_ROOT_PASSWORD
